<script>
const MY_LIFF_ID = "2008725016-UORywLSJ";

function log(msg){
  const d = document.getElementById("debugLog");
  d.textContent += msg + "\n";
}

function setStatus(msg){
  document.getElementById("status").textContent = msg;
}

// これが出なければ「JS自体が動いてない」
document.addEventListener("DOMContentLoaded", () => {
  setStatus("JS起動しました");
  log("DOM loaded");
  log("href: " + location.href);
  log("ua: " + navigator.userAgent);
});

// 例外を握りつぶさない
window.onerror = function(message, source, lineno, colno, error) {
  setStatus("JSエラー");
  log("window.onerror: " + message);
  if (error && error.stack) log(error.stack);
};

function withTimeout(promise, ms, label) {
  return Promise.race([
    promise,
    new Promise((_, reject) =>
      setTimeout(() => reject(new Error(`${label} timeout after ${ms}ms`)), ms)
    ),
  ]);
}

window.addEventListener("load", async () => {
  log("window.load");
  try {
    setStatus("LIFF初期化中...");
    log("liff.init start: " + MY_LIFF_ID);

    await withTimeout(
      liff.init({ liffId: MY_LIFF_ID, withLoginOnExternalBrowser: true }),
      15000,
      "liff.init"
    );

    log("liff.init OK");
    await liff.ready;
    log("liff.ready OK");

    log("isInClient: " + liff.isInClient());
    log("isLoggedIn: " + liff.isLoggedIn());

    if (!liff.isLoggedIn()) {
      setStatus("ログイン中...");
      log("calling liff.login()");
      liff.login({ redirectUri: location.href });
      return;
    }

    const profile = await liff.getProfile();
    setStatus("LINE連携OK: " + profile.displayName);
    log("profile OK: " + profile.userId);

  } catch (e) {
    setStatus("LIFF初期化エラー");
    log("FATAL: " + (e.stack || e.message || e));
  }
});
</script>
