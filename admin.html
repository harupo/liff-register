<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEメッセージ管理</title>
    <style>
        :root {
            --bg: #f3f4f6; --white: #ffffff; --primary: #2563eb;
            --user-bg: #f9fafb; --in-msg: #ffffff; --out-msg: #dcf8c6;
        }
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: var(--bg); }
        
        /* ユーザーリスト */
        #userList { width: 300px; border-right: 1px solid #e5e7eb; background: var(--user-bg); display: flex; flex-direction: column; }
        .list-header { padding: 20px; font-weight: bold; background: #1f2937; color: white; }
        #users { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: 0.2s; }
        .user-item:hover { background: #e5e7eb; }
        .user-item.active { background: #d1e7ff; border-left: 5px solid var(--primary); }

        /* チャットエリア */
        #chatArea { flex: 1; display: flex; flex-direction: column; background: #ebebeb; }
        #history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* メッセージの吹き出し */
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 15px; font-size: 14px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg small { display: block; font-size: 10px; color: #6b7280; margin-bottom: 4px; }
        .in { align-self: flex-start; background: var(--in-msg); border-bottom-left-radius: 2px; }
        .out { align-self: flex-end; background: var(--out-msg); border-bottom-right-radius: 2px; }

        /* 入力エリア */
        #inputArea { padding: 20px; background: var(--white); border-top: 1px solid #e5e7eb; display: flex; gap: 10px; align-items: center; }
        #replyText { flex: 1; height: 40px; padding: 10px; border: 1px solid #d1d5db; border-radius: 20px; outline: none; resize: none; }
        #sendBtn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        #sendBtn:disabled { background: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="userList">
    <div class="list-header">顧客メッセージ一覧</div>
    <div id="users"></div>
</div>

<div id="chatArea">
    <div id="history">ユーザーを選択してください</div>
    <div id="inputArea">
        <textarea id="replyText" placeholder="メッセージを入力..."></textarea>
        <button id="sendBtn" onclick="sendReply()">送信</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxV6pUiDmTdd5mz4nKpND4h5K9_2rOi21Hi39QAI0xXBBVYKhGmF7kFOufwJVBLj5YZ/exec";
    let selectedUserId = "";
    let messages = [];

    // JSONPリクエスト用
    function jsonp(params) {
        return new Promise((resolve, reject) => {
            const cb = "cb_" + Math.random().toString(36).slice(2);
            const script = document.createElement("script");
            const timeout = setTimeout(() => reject("Timeout"), 15000);
            
            window[cb] = (res) => {
                clearTimeout(timeout);
                resolve(res);
                delete window[cb];
                script.remove();
            };
            
            const q = new URLSearchParams({...params, callback: cb});
            script.src = `${GAS_URL}?${q.toString()}`;
            document.head.appendChild(script);
        });
    }

    // メッセージの取得と更新
    async function refresh() {
        try {
            const res = await jsonp({ action: "getMessages" });
            if (res.status === "ok") {
                messages = res.data;
                renderUserList();
                if (selectedUserId) renderChat();
            }
        } catch (e) { console.error("Refresh error:", e); }
    }

    // 左側のユーザーリストを表示
    function renderUserList() {
        const uSet = [...new Set(messages.map(m => m.lineUserId))];
        const container = document.getElementById("users");
        container.innerHTML = uSet.length ? "" : "<p style='padding:20px'>メッセージはありません</p>";
        
        uSet.forEach(uid => {
            const div = document.createElement("div");
            div.className = "user-item" + (uid === selectedUserId ? " active" : "");
            div.innerText = "ユーザー: " + uid.substring(0, 8) + "...";
            div.onclick = () => {
                selectedUserId = uid;
                renderChat();
                renderUserList();
            };
            container.appendChild(div);
        });
    }

    // 右側のチャット履歴を表示
    function renderChat() {
        const history = document.getElementById("history");
        history.innerHTML = "";
        const filtered = messages.filter(m => m.lineUserId === selectedUserId);
        
        filtered.forEach(m => {
            const div = document.createElement("div");
            div.className = `msg ${m.direction}`;
            div.innerHTML = `<small>${m.timestamp}</small>${m.text}`;
            history.appendChild(div);
        });
        history.scrollTop = history.scrollHeight;
    }

    // メッセージ送信
    async function sendReply() {
        const textEl = document.getElementById("replyText");
        const btn = document.getElementById("sendBtn");
        const text = textEl.value.trim();
        
        if (!selectedUserId || !text) return;
        
        btn.disabled = true;
        try {
            const res = await jsonp({ action: "sendReply", lineUserId: selectedUserId, text: text });
            if (res.status === "ok") {
                textEl.value = "";
                await refresh();
            } else {
                alert("送信に失敗しました: " + res.message);
            }
        } catch (e) { alert("エラーが発生しました"); }
        btn.disabled = false;
    }

    // 15秒ごとに自動更新
    setInterval(refresh, 15000);
    refresh();
</script>

</body>
</html>